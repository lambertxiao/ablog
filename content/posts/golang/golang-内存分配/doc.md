---
author: "Lambert Xiao"
title: "golang-å†…å­˜ç®¡ç†"
date: "2022-03-12"
summary: "ç©ºé—²é“¾è¡¨ + å¤šè§„æ ¼å¤šçº§åˆ«ç®¡ç†"
tags: ["å†…å­˜ç®¡ç†"]
categories: [""]
series: ["Themes Guide"]
ShowToc: true
TocOpen: true
cover:
  image: "/cover/golang-å†…å­˜ç®¡ç†.png"
---

## ç©ºé—²é“¾è¡¨æ³•

ç©ºé—²é“¾è¡¨æ³•ä¼šåœ¨å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¼šä¾æ¬¡éå†ç©ºé—²çš„å†…å­˜å—ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç”³è¯·æ–°çš„èµ„æºå¹¶ä¿®æ”¹é“¾è¡¨ã€‚

å› ä¸ºä¸åŒçš„å†…å­˜å—é€šè¿‡æŒ‡é’ˆæ„æˆäº†é“¾è¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åˆ†é…å™¨å¯ä»¥é‡æ–°åˆ©ç”¨å›æ”¶çš„èµ„æºï¼Œä½†æ˜¯å› ä¸ºåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ ğ‘‚(ğ‘›)ã€‚

ç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©ï¼Œæœ€å¸¸è§çš„æ˜¯ä»¥ä¸‹å››ç§ï¼š

- é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›

- å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›

- æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼›

- éš”ç¦»é€‚åº”ï¼ˆSegregated-Fitï¼‰â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼›

## GOè¯­è¨€ä¸­çš„ä¼˜åŒ–

### 1. å¤šè§„æ ¼å†…å­˜ç®¡ç†

ä¸Šé¢è¯´è¿‡æ™®é€šçš„ç©ºé—²é“¾è¡¨æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºğ‘‚(ğ‘›)ï¼Œèªæ˜çš„GOå·¥ç¨‹å¸ˆä»¬åœ¨æ­¤ä¹‹ä¸Šåˆåšäº†ä¸å°‘ä¼˜åŒ–ï¼ŒGoè¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¼šæ ¹æ®ç”³è¯·åˆ†é…çš„å†…å­˜å¤§å°é€‰æ‹©ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„å¤§å°å°†å¯¹è±¡åˆ†æˆå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ä¸‰ç§ï¼š

|ç±»åˆ« |	å¤§å° |
| - | - |
| å¾®å¯¹è±¡ | (0, 16B) |
| å°å¯¹è±¡ | [16B, 32KB] |
| å¤§å¯¹è±¡ | (32KB, +âˆ) |

ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤„ç†å‘¢ï¼Ÿæ˜¯å› ä¸ºç¨‹åºå®é™…è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œç»å¤§å¤šæ•°çš„å¯¹è±¡å¤§å°éƒ½åœ¨32KBä»¥ä¸‹ï¼Œè€Œç”³è¯·çš„å†…å­˜å¤§å°å½±å“ Go è¯­è¨€è¿è¡Œæ—¶åˆ†é…å†…å­˜çš„è¿‡ç¨‹å’Œå¼€é”€ï¼Œæ‰€ä»¥åˆ†åˆ«å¤„ç†å¤§å¯¹è±¡å’Œå°å¯¹è±¡æœ‰åˆ©äºæé«˜å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½ã€‚

### 2. å¤šçº§å†…å­˜ç®¡ç†

å°†å†…å­˜åˆ†æˆä¸åŒçš„çº§åˆ«åˆ†åˆ«ç®¡ç†ï¼ŒTCMalloc å’Œ Go è¿è¡Œæ—¶åˆ†é…å™¨éƒ½ä¼šå¼•å…¥çº¿ç¨‹ç¼“å­˜ï¼ˆThread Cacheï¼‰ã€ä¸­å¿ƒç¼“å­˜ï¼ˆCentral Cacheï¼‰å’Œé¡µå †ï¼ˆPage Heapï¼‰ä¸‰ä¸ªç»„ä»¶åˆ†çº§ç®¡ç†å†…å­˜ï¼š

![](../1.png)

1. çº¿ç¨‹ç¼“å­˜ä½¿å¾—åœ¨ä¸€ä¸ªçº¿ç¨‹å†…åˆ†é…å†…å­˜æ— éœ€åŠ é”ï¼Œå‡å°‘é”ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—

2. å½“çº¿ç¨‹ç¼“å­˜ä¸å¤Ÿç”¨æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨ä¸­å¿ƒç¼“å­˜ä½œä¸ºè¡¥å……è§£å†³å°å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œåœ¨é‡åˆ° 32KB ä»¥ä¸Šçš„å¯¹è±¡æ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¼šé€‰æ‹©é¡µå †ç›´æ¥åˆ†é…å¤§å†…å­˜ã€‚

## GO 1.10çš„è™šæ‹Ÿå†…å­˜å¸ƒå±€

Go è¯­è¨€ç¨‹åºçš„ 1.10 ç‰ˆæœ¬åœ¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–æ•´ç‰‡è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªåŒºåŸŸ spansã€bitmap å’Œ arena åˆ†åˆ«é¢„ç•™äº† 512MBã€16GB ä»¥åŠ 512GB çš„å†…å­˜ç©ºé—´ï¼Œè¿™äº›å†…å­˜å¹¶ä¸æ˜¯çœŸæ­£å­˜åœ¨çš„ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯è™šæ‹Ÿå†…å­˜

![](../2.png)

- spans åŒºåŸŸå­˜å‚¨äº†æŒ‡å‘å†…å­˜ç®¡ç†å•å…ƒ runtime.mspan çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¼šç®¡ç†å‡ é¡µçš„å†…å­˜ç©ºé—´ï¼Œæ¯é¡µå¤§å°ä¸º 8KBï¼›

  > spansåŒºåŸŸå­˜æ”¾çš„åªæ˜¯æŒ‡é’ˆï¼Œå®é™…mspançš„å†…å®¹è¿˜æ˜¯åœ¨arenaä¸Šçš„

- bitmap ç”¨äºæ ‡è¯† arena åŒºåŸŸä¸­çš„é‚£äº›åœ°å€ä¿å­˜äº†å¯¹è±¡ï¼Œä½å›¾ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½ä¼šè¡¨ç¤ºå †åŒºä¸­çš„ 32 å­—èŠ‚æ˜¯å¦ç©ºé—²ï¼›

  > æ‰€ä»¥arenaçš„å¤§å°é™¤ä»¥32ç­‰äºbitmapçš„å¤§å°

- arena åŒºåŸŸæ˜¯çœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶ä¼šå°† 8KB çœ‹åšä¸€é¡µï¼Œè¿™äº›å†…å­˜é¡µä¸­å­˜å‚¨äº†æ‰€æœ‰åœ¨å †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡ï¼›

  > å¯¹äºä»»æ„ä¸€ä¸ªåœ°å€ï¼Œå¯ä»¥æ ¹æ® arena çš„åŸºåœ°å€è®¡ç®—è¯¥åœ°å€æ‰€åœ¨çš„é¡µæ•°å¹¶é€šè¿‡ spans æ•°ç»„è·å¾—ç®¡ç†è¯¥ç‰‡å†…å­˜çš„ç®¡ç†å•å…ƒ `runtime.mspan`

## GO 1.11çš„è™šæ‹Ÿå†…å­˜å¸ƒå±€

![](../3.png)

æ•´ä¸ªå †å†…å­˜åˆ’åˆ†æˆäº†ä¸€å—å—å°çš„heap arena(æ¯ä¸ª64MB)

> è¿™ä¹ˆåšçš„åŸå› ï¼Ÿæ˜¯å› ä¸ºCå’ŒGoæ··åˆä½¿ç”¨æ—¶ï¼Œæ— æ³•ç»´æŠ¤å †åŒºçš„å†…å­˜æ˜¯è¿ç»­çš„ã€‚ä½¿ç”¨ç¨€ç–çš„å†…å­˜å¸ƒå±€ä¸ä»…èƒ½ç§»é™¤å †å¤§å°çš„ä¸Šé™ï¼Œè¿˜èƒ½è§£å†³ C å’Œ Go æ··åˆä½¿ç”¨æ—¶çš„åœ°å€ç©ºé—´å†²çªé—®é¢˜ã€‚ä¸è¿‡å› ä¸ºåŸºäºç¨€ç–å†…å­˜çš„å†…å­˜ç®¡ç†å¤±å»äº†å†…å­˜çš„è¿ç»­æ€§è¿™ä¸€å‡è®¾ï¼Œè¿™ä¹Ÿä½¿å†…å­˜ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚

ç„ä¸€çœ¼heap arenaçš„ç»“æ„ä½“

```go
type heapArena struct {
	bitmap       [heapArenaBitmapBytes]byte
	spans        [pagesPerArena]*mspan
	pageInUse    [pagesPerArena / 8]uint8
	pageMarks    [pagesPerArena / 8]uint8
	pageSpecials [pagesPerArena / 8]uint8
	checkmarks   *checkmarksMap
	zeroedBase   uintptr
}
```

1. bitmapå’ŒspansåŒ1.10ç‰ˆæœ¬çš„ç±»ä¼¼
2. pageInUse
3. zeroedBaseè®°å½•äº†è¯¥ç»“æ„ä½“ç®¡ç†çš„å†…å­˜çš„åŸºåœ°å€

## åœ°å€ç©ºé—´

å› ä¸ºæ‰€æœ‰çš„å†…å­˜æœ€ç»ˆéƒ½æ˜¯è¦ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·çš„ï¼Œæ‰€ä»¥ Go è¯­è¨€çš„è¿è¡Œæ—¶æ„å»ºäº†æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æŠ½è±¡å±‚ï¼Œè¯¥æŠ½è±¡å±‚å°†è¿è¡Œæ—¶ç®¡ç†çš„åœ°å€ç©ºé—´åˆ†æˆä»¥ä¸‹å››ç§çŠ¶æ€

| çŠ¶æ€ |	è§£é‡Š |
|-|-|
| None |	å†…å­˜æ²¡æœ‰è¢«ä¿ç•™æˆ–è€…æ˜ å°„ï¼Œæ˜¯åœ°å€ç©ºé—´çš„é»˜è®¤çŠ¶æ€ |
| Reserved |	è¿è¡Œæ—¶æŒæœ‰è¯¥åœ°å€ç©ºé—´ï¼Œä½†æ˜¯è®¿é—®è¯¥å†…å­˜ä¼šå¯¼è‡´é”™è¯¯ |
| Prepared |	å†…å­˜è¢«ä¿ç•™ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜è®¿é—®è¯¥ç‰‡å†…å­˜çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„å¯ä»¥å¿«é€Ÿè½¬æ¢åˆ° Ready çŠ¶æ€ |
| Ready |	å¯ä»¥è¢«å®‰å…¨è®¿é—® |

![](../4.png)

å¯ä»¥çœ‹å‡ºä»¥ä¸Šæœ‰å¥½å‡ ä¸ªç³»ç»Ÿè°ƒç”¨

> å¯¹åº”ä»£ç ï¼šgo/src/runtime/mem_linux.go

| å‡½æ•° | ä½œç”¨|
| - | - |
|runtime.sysAlloc | ä¼šä»æ“ä½œç³»ç»Ÿä¸­è·å–ä¸€å¤§å—å¯ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¯èƒ½ä¸ºå‡ ç™¾ KB æˆ–è€…å‡  MBï¼›|
|runtime.sysFree | ä¼šåœ¨ç¨‹åºå‘ç”Ÿå†…å­˜ä¸è¶³ï¼ˆOut-of Memoryï¼ŒOOMï¼‰æ—¶è°ƒç”¨å¹¶æ— æ¡ä»¶åœ°è¿”å›å†…å­˜ï¼›|
|runtime.sysReserve | ä¼šä¿ç•™æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œè®¿é—®è¿™ç‰‡å†…å­˜ä¼šè§¦å‘å¼‚å¸¸ï¼›|
|runtime.sysMap | ä¿è¯å†…å­˜åŒºåŸŸå¯ä»¥å¿«é€Ÿè½¬æ¢è‡³å°±ç»ªçŠ¶æ€ï¼›|
|runtime.sysUsed | é€šçŸ¥æ“ä½œç³»ç»Ÿåº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨è¯¥å†…å­˜åŒºåŸŸï¼Œä¿è¯å†…å­˜åŒºåŸŸå¯ä»¥å®‰å…¨è®¿é—®ï¼›|
|runtime.sysUnused | é€šçŸ¥æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜å¯¹åº”çš„ç‰©ç†å†…å­˜å·²ç»ä¸å†éœ€è¦ï¼Œå¯ä»¥é‡ç”¨ç‰©ç†å†…å­˜ï¼›|
|runtime.sysFault | å°†å†…å­˜åŒºåŸŸè½¬æ¢æˆä¿ç•™çŠ¶æ€ï¼Œä¸»è¦ç”¨äºè¿è¡Œæ—¶çš„è°ƒè¯•ï¼›|

## å†…å­˜ç®¡ç†ç»„ä»¶

![](../5.png)

æ‰€æœ‰çš„ Go è¯­è¨€ç¨‹åºéƒ½ä¼šåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å†…å­˜å¸ƒå±€ï¼Œ

1. æ¯ä¸€ä¸ªå¤„ç†å™¨Péƒ½ä¼šåˆ†é…ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ runtime.mcache ç”¨äºå¤„ç†å¾®å¯¹è±¡å’Œå°å¯¹è±¡çš„åˆ†é…
2. mcacheä¼šæŒæœ‰`å†…å­˜ç®¡ç†å•å…ƒruntime.mspan`
3. æ¯ä¸ªç±»å‹çš„mspanéƒ½ä¼šç®¡ç†ç‰¹å®šå¤§å°çš„å¯¹è±¡
4. å½“mspanä¸­ä¸å­˜åœ¨ç©ºé—²å¯¹è±¡æ—¶ï¼Œå®ƒä»¬ä¼šä» runtime.mheap æŒæœ‰çš„ 134 ä¸ªä¸­å¿ƒç¼“å­˜ runtime.mcentral ä¸­è·å–æ–°çš„å†…å­˜å•å…ƒ
5. ä¸­å¿ƒç¼“å­˜å±äºå…¨å±€çš„å †ç»“æ„ä½“ runtime.mheapï¼Œå®ƒä¼šä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜ã€‚

### mspan

```go
type mspan struct {
    startAddr uintptr // èµ·å§‹åœ°å€
    npages    uintptr // é¡µæ•°
    freeindex uintptr
    allocBits  *gcBits
    gcmarkBits *gcBits
    allocCache  uint64
    state       mSpanStateBox
    spanclass   spanClass
    ...
}
```

- startAddr å’Œ npages â€” ç¡®å®šè¯¥ç»“æ„ä½“ç®¡ç†çš„å¤šä¸ªé¡µæ‰€åœ¨çš„å†…å­˜ï¼Œæ¯ä¸ªé¡µçš„å¤§å°éƒ½æ˜¯ 8KBï¼›
- freeindex â€” æ‰«æé¡µä¸­ç©ºé—²å¯¹è±¡çš„åˆå§‹ç´¢å¼•ï¼›
- allocBits å’Œ gcmarkBits â€” åˆ†åˆ«ç”¨äºæ ‡è®°å†…å­˜çš„å ç”¨å’Œå›æ”¶æƒ…å†µï¼›
- allocCache â€” allocBits çš„è¡¥ç ï¼Œå¯ä»¥ç”¨äºå¿«é€ŸæŸ¥æ‰¾å†…å­˜ä¸­æœªè¢«ä½¿ç”¨çš„å†…å­˜
- stateè¢«GCç”¨åˆ°äº†ï¼Œæœ‰å››ç§çŠ¶æ€ï¼šmSpanDeadã€mSpanInUseã€mSpanManual å’Œ mSpanFree
- spanclassæ˜¯ä¸€ä¸ª uint8 ç±»å‹çš„æ•´æ•°ï¼Œå®ƒçš„å‰ 7 ä½å­˜å‚¨ç€è·¨åº¦ç±»çš„ IDï¼Œæœ€åä¸€ä½è¡¨ç¤ºæ˜¯å¦åŒ…å«æŒ‡é’ˆã€‚ä»è·¨åº¦ç±»çš„IDå¯ä»¥çŸ¥é“mspanç®¡ç†çš„å¯¹è±¡çš„è§„æ ¼å’Œä¸ªæ•°
  > spanclassçš„ç§ç±»å¯å‚è§æºç : /go/src/runtime/sizeclasses.go

å½“å‘ runtime.mspan ç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ allocCache å­—æ®µä»¥å¯¹è±¡ä¸ºå•ä½åœ¨ç®¡ç†çš„å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾å¾…åˆ†é…çš„ç©ºé—´

![](../6.png)

### mcache

```go
type mcache struct {
    ...
	alloc [numSpanClasses]*mspan // spans to allocate from, indexed by spanClass
    ...
	tiny             uintptr
	tinyoffset       uintptr
	local_tinyallocs uintptr
}
```

runtime.mcache æ˜¯ Go è¯­è¨€ä¸­çš„çº¿ç¨‹ç¼“å­˜ï¼Œå®ƒä¼šä¸çº¿ç¨‹ä¸Šçš„å¤„ç†å™¨Pä¸€ä¸€ç»‘å®šï¼Œä¸»è¦ç”¨æ¥ç¼“å­˜ç”¨æˆ·ç¨‹åºç”³è¯·çš„å¾®å°å¯¹è±¡ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜éƒ½æŒæœ‰ 68 * 2 ä¸ª runtime.mspanï¼Œè¿™äº›å†…å­˜ç®¡ç†å•å…ƒéƒ½å­˜å‚¨åœ¨ç»“æ„ä½“çš„ alloc å­—æ®µä¸­ï¼š

> 68*2çš„åŸå› æ˜¯sizeclassæ€»å…±æœ‰68ç§ï¼Œå…¶ä¸­mcacheæŒæœ‰å«æŒ‡é’ˆå’Œä¸å«æŒ‡é’ˆçš„mspanå„68ä¸ªï¼Œæ€»è®¡å°±æ˜¯68*2ä¸ª

![](../7.png)

mcacheåˆšåˆšè¢«åˆå§‹åŒ–æ—¶æ˜¯ä¸åŒ…å« runtime.mspan çš„ï¼Œåªæœ‰å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶æ‰ä¼šä»ä¸Šä¸€çº§ç»„ä»¶è·å–æ–°çš„ runtime.mspan æ»¡è¶³å†…å­˜åˆ†é…çš„éœ€æ±‚ã€‚

```go
func allocmcache() *mcache {
	var c *mcache
	systemstack(func() {
		lock(&mheap_.lock)
		c = (*mcache)(mheap_.cachealloc.alloc())
		c.flushGen = mheap_.sweepgen
		unlock(&mheap_.lock)
	})
	for i := range c.alloc {
		c.alloc[i] = &emptymspan // åˆ†é…äº†ä¸ªç©ºçš„emptymspan
	}
	c.nextSample = nextSample()
	return c
}
```

runtime.mcache.refill ä¼šä¸ºmcacheè·å–ä¸€ä¸ªæŒ‡å®šè·¨åº¦ç±»çš„mspan

```go
func (c *mcache) refill(spc spanClass) {
	s := c.alloc[spc]
	s = mheap_.central[spc].mcentral.cacheSpan() // çœ‹è¿™é‡Œï¼Œmcacheå‘mheapé‡Œçš„mcentralæ‹¿åˆ°äº†mspan
	c.alloc[spc] = s
}
```

çº¿ç¨‹ç¼“å­˜ä¸­è¿˜åŒ…å«å‡ ä¸ªç”¨äºåˆ†é…å¾®å¯¹è±¡çš„å­—æ®µï¼Œä¸‹é¢çš„è¿™ä¸‰ä¸ªå­—æ®µç»„æˆäº†å¾®å¯¹è±¡åˆ†é…å™¨ï¼Œä¸“é—¨ç®¡ç† 16 å­—èŠ‚ä»¥ä¸‹çš„å¯¹è±¡ï¼š

```go
type mcache struct {
	tiny             uintptr
	tinyoffset       uintptr
	local_tinyallocs uintptr
}
```

1. tiny ä¼šæŒ‡å‘å †ä¸­çš„ä¸€ç‰‡å†…å­˜
2. tinyOffset æ˜¯ä¸‹ä¸€ä¸ªç©ºé—²å†…å­˜æ‰€åœ¨çš„åç§»é‡
3. local_tinyallocs ä¼šè®°å½•å†…å­˜åˆ†é…å™¨ä¸­åˆ†é…çš„å¯¹è±¡ä¸ªæ•°

### mcentral

runtime.mcentral æ˜¯å†…å­˜åˆ†é…å™¨çš„ä¸­å¿ƒç¼“å­˜ï¼Œä¸çº¿ç¨‹ç¼“å­˜ä¸åŒï¼Œè®¿é—®ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒéœ€è¦ä½¿ç”¨äº’æ–¥é”

```go
type mcentral struct {
	spanclass spanClass
	partial  [2]spanSet
	full     [2]spanSet
}
```

æ¯ä¸ªä¸­å¿ƒç¼“å­˜éƒ½ä¼šç®¡ç†æŸä¸ªè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå®ƒä¼šåŒæ—¶æŒæœ‰ä¸¤ä¸ª runtime.spanSetï¼Œåˆ†åˆ«å­˜å‚¨åŒ…å«ç©ºé—²å¯¹è±¡å’Œä¸åŒ…å«ç©ºé—²å¯¹è±¡çš„å†…å­˜ç®¡ç†å•å…ƒã€‚

ä¸Šé¢è¯´è¿‡ï¼Œmcacheé—´æ¥è°ƒç”¨äº†mcentral.cacheSpan æ–¹æ³•è·å–æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå…·ä½“å†…éƒ¨ç»†èŠ‚ï¼š

1. è°ƒç”¨ mcentral.partialSwept ä»æ¸…ç†è¿‡çš„ã€åŒ…å«ç©ºé—²ç©ºé—´çš„ runtime.spanSet ç»“æ„ä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
2. è°ƒç”¨ mcentral.partialUnswept ä»æœªè¢«æ¸…ç†è¿‡çš„ã€æœ‰ç©ºé—²å¯¹è±¡çš„ runtime.spanSet ç»“æ„ä¸­æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
3. è°ƒç”¨ mcentral.fullUnswept è·å–æœªè¢«æ¸…ç†çš„ã€ä¸åŒ…å«ç©ºé—²ç©ºé—´çš„ runtime.spanSet ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒå¹¶é€šè¿‡ runtime.mspan.sweep æ¸…ç†å®ƒçš„å†…å­˜ç©ºé—´ï¼›
4. è°ƒç”¨ runtime.mcentral.grow ä»å †ä¸­ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒï¼›
5. æ›´æ–°å†…å­˜ç®¡ç†å•å…ƒçš„ allocCache ç­‰å­—æ®µå¸®åŠ©å¿«é€Ÿåˆ†é…å†…å­˜ï¼›

### mheap

runtime.mheap æ˜¯å†…å­˜åˆ†é…çš„æ ¸å¿ƒç»“æ„ä½“ï¼ŒGo è¯­è¨€ç¨‹åºä¼šå°†å…¶ä½œä¸ºå…¨å±€å˜é‡å­˜å‚¨ï¼Œè€Œå †ä¸Šåˆå§‹åŒ–çš„æ‰€æœ‰å¯¹è±¡éƒ½ç”±è¯¥ç»“æ„ä½“ç»Ÿä¸€ç®¡ç†ï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«ä¸¤ç»„éå¸¸é‡è¦çš„å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å…¨å±€çš„ä¸­å¿ƒç¼“å­˜åˆ—è¡¨ centralï¼Œå¦ä¸€ä¸ªæ˜¯ç®¡ç†å †åŒºå†…å­˜åŒºåŸŸçš„ arenas ä»¥åŠç›¸å…³å­—æ®µã€‚

é¡µå †ä¸­åŒ…å«ä¸€ä¸ªé•¿åº¦ä¸º 136 çš„ runtime.mcentral æ•°ç»„ï¼Œå…¶ä¸­ 68 ä¸ªä¸ºè·¨åº¦ç±»éœ€è¦ scan çš„ä¸­å¿ƒç¼“å­˜ï¼Œå¦å¤–çš„ 68 ä¸ªæ˜¯ noscan çš„ä¸­å¿ƒç¼“å­˜

### å¯¹è±¡åˆ†é…

å †ä¸Šæ‰€æœ‰çš„å¯¹è±¡éƒ½ä¼šé€šè¿‡è°ƒç”¨ runtime.newobject å‡½æ•°åˆ†é…å†…å­˜ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ runtime.mallocgc åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ç”¨æˆ·ç¨‹åºå‘å †ä¸Šç”³è¯·å†…å­˜ç©ºé—´çš„å¿…ç»å‡½æ•°

#### æ€»çš„åˆ†é…é€»è¾‘

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	mp := acquirem()
	mp.mallocing = 1

	c := gomcache()
	var x unsafe.Pointer
	noscan := typ == nil || typ.ptrdata == 0
	if size <= maxSmallSize {
		if noscan && size < maxTinySize {
			// å¾®å¯¹è±¡åˆ†é…
		} else {
			// å°å¯¹è±¡åˆ†é…
		}
	} else {
		// å¤§å¯¹è±¡åˆ†é…
	}

	publicationBarrier()
	mp.mallocing = 0
	releasem(mp)

	return x
}
```

#### å¾®å°å¯¹è±¡åˆ†é…é€»è¾‘

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
  ...
  if size <= maxSmallSize {
    if noscan && size < maxTinySize {
      off := c.tinyoffset
      if off+size <= maxTinySize && c.tiny != 0 {
        x = unsafe.Pointer(c.tiny + off)
        c.tinyoffset = off + size
        c.local_tinyallocs++
        releasem(mp)
        return x
      }
      span := c.alloc[tinySpanClass]
      v := nextFreeFast(span)
      if v == 0 {
        v, _, _ = c.nextFree(tinySpanClass)
      }

      x = unsafe.Pointer(v)
      (*[2]uint64)(x)[0] = 0
      (*[2]uint64)(x)[1] = 0

      if size < c.tinyoffset || c.tiny == 0 {
        c.tiny = uintptr(x)
        c.tinyoffset = size
      }
      size = maxTinySize
      ...
		}
		...
	}
	...
}
```

1. çº¿ç¨‹ç¼“å­˜ runtime.mcache ä¸­çš„ tiny å­—æ®µæŒ‡å‘äº† maxTinySize å¤§å°çš„å—ï¼Œå¦‚æœå½“å‰å—ä¸­è¿˜åŒ…å«å¤§å°åˆé€‚çš„ç©ºé—²å†…å­˜ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡åŸºåœ°å€å’Œåç§»é‡è·å–å¹¶è¿”å›è¿™å—å†…å­˜
2. å½“å†…å­˜å—ä¸­ä¸åŒ…å«ç©ºé—²çš„å†…å­˜æ—¶ï¼Œä¼šå…ˆä»çº¿ç¨‹ç¼“å­˜æ‰¾åˆ°è·¨åº¦ç±»å¯¹åº”çš„å†…å­˜ç®¡ç†å•å…ƒ runtime.mspanï¼Œè°ƒç”¨ runtime.nextFreeFast è·å–ç©ºé—²çš„å†…å­˜ï¼›å½“ä¸å­˜åœ¨ç©ºé—²å†…å­˜æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ runtime.mcache.nextFree ä»ä¸­å¿ƒç¼“å­˜æˆ–è€…é¡µå †ä¸­è·å–å¯åˆ†é…çš„å†…å­˜å—

#### å°å¯¹è±¡åˆ†é…é€»è¾‘

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		...
		} else {
			var sizeclass uint8
			if size <= smallSizeMax-8 {
				sizeclass = size_to_class8[(size+smallSizeDiv-1)/smallSizeDiv]
			} else {
				sizeclass = size_to_class128[(size-smallSizeMax+largeSizeDiv-1)/largeSizeDiv]
			}
			size = uintptr(class_to_size[sizeclass])
			spc := makeSpanClass(sizeclass, noscan)
			span := c.alloc[spc]
			v := nextFreeFast(span)
			if v == 0 {
				v, span, _ = c.nextFree(spc)
			}
			x = unsafe.Pointer(v)
			if needzero && span.needzero != 0 {
				memclrNoHeapPointers(unsafe.Pointer(v), size)
			}
		}
	} else {
		...
	}
	...
	return x
}
```

1. ç¡®å®šåˆ†é…å¯¹è±¡çš„å¤§å°ä»¥åŠè·¨åº¦ç±» runtime.spanClassï¼›
2. ä»çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜æˆ–è€…å †ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒå¹¶ä»å†…å­˜ç®¡ç†å•å…ƒæ‰¾åˆ°ç©ºé—²çš„å†…å­˜ç©ºé—´ï¼›
3. è°ƒç”¨ runtime.memclrNoHeapPointers æ¸…ç©ºç©ºé—²å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®ï¼›

#### å¤§å¯¹è±¡åˆ†é…é€»è¾‘

```go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
	...
	if size <= maxSmallSize {
		...
	} else {
		var s *mspan
		span = c.allocLarge(size, needzero, noscan)
		span.freeindex = 1
		span.allocCount = 1
		x = unsafe.Pointer(span.base())
		size = span.elemsize
	}

	publicationBarrier()
	mp.mallocing = 0
	releasem(mp)

	return x
}
```

1. è¿è¡Œæ—¶å¯¹äºå¤§äº 32KB çš„å¤§å¯¹è±¡ä¼šå•ç‹¬å¤„ç†ï¼Œæˆ‘ä»¬ä¸ä¼šä»çº¿ç¨‹ç¼“å­˜æˆ–è€…ä¸­å¿ƒç¼“å­˜ä¸­è·å–å†…å­˜ç®¡ç†å•å…ƒï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ runtime.mcache.allocLarge åˆ†é…å¤§ç‰‡å†…å­˜

2. runtime.mcache.allocLarge ä¼šè®¡ç®—åˆ†é…è¯¥å¯¹è±¡æ‰€éœ€è¦çš„é¡µæ•°ï¼Œå®ƒæŒ‰ç…§ 8KB çš„å€æ•°åœ¨å †ä¸Šç”³è¯·å†…å­˜
